<!DOCTYPE html>
<!--[if IE 8]> <html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9]> <html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!--> <html lang="en"> <!--<![endif]-->
<head>
<title>Codurance - Design Patterns in the 21st Century: The Chain of Responsibility Pattern</title>
 <!-- Meta -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">

<!-- Open Graph tags - Used when publishing on Facebook -->
<meta property="og:site_name" content="Codurance"/>
<meta property="og:description" content="We build well-crafted software"/>
<meta property="og:url" content="http://codurance.com"/>
<meta property="og:image" content="http://codurance.com/assets/img/codurance.png"/>

<!-- Favicon -->
<link rel="shortcut icon" href="favicon.ico">

<!-- CSS Global Compulsory -->
<link rel="stylesheet" href="/assets/plugins/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/assets/css/style.css">

<!-- CSS Implementing Plugins -->
<link rel="stylesheet" href="/assets/plugins/line-icons/line-icons.css">
<link rel="stylesheet" href="/assets/plugins/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/assets/plugins/owl-carousel/owl-carousel/owl.carousel.css">

<!-- CSS Theme -->  
<link rel="stylesheet" href="/assets/css/plugins.css">
<link rel="stylesheet" href="/assets/css/app.css">  
<link rel="stylesheet" href="/assets/css/theme-colors/orange.css" id="style_color">

<!-- CSS Customization -->
<link rel="stylesheet" href="/assets/css/custom.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/idea.min.css">
<!--fonts -->
<link href='http://fonts.googleapis.com/css?family=Oxygen:700,400' rel='stylesheet' type='text/css'>


<link rel="canonical" href="http://monospacedmonologues.com/post/116569171260/design-patterns-in-the-21st-century-the-chain-of" />


<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46289079-1', 'codurance.com');
    ga('send', 'pageview');
</script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</head>

<body>

<div class="wrapper">
<!--=== Header ===-->
<div class="header-v3 header-sticky">
        <!-- Navbar -->
        <div class="navbar navbar-default" role="navigation">
            <div class="container">
                <!-- Brand and toggle get grouped for better mobile display -->
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="fa fa-bars"></span>
                    </button>
                    <a class="navbar-brand" href="/">
                        <img id="logo-header" src="/assets/img/codurance.png" height="45px;" alt="Logo">
                    </a>
                </div>

                <!-- Collect the nav links, forms, and other content for toggling -->
                <div class="collapse navbar-collapse navbar-responsive-collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="/services">Services</a></li>
                        <li><a href="/casestudies">Case Studies</a></li>
                        <li><a href="/videos">Videos</a></li>
                        <li><a href="/blog">Blog</a></li>
                        <li><a href="/careers/craftsman">Careers</a></li>
                        <li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown">About Us <i class="icon-angle-down">&nbsp;</i></a><ul class="dropdown-menu">
                            <li><a href="/aboutus/ourteam">Our Team</a></li>
                            <li><a href="/aboutus/ourcompany">Our Company</a></li>
                            <li><a href="/aboutus/ourpractices">Our Practices</a></li>
                        </ul></li>
                    </ul>
                </div><!--/navbar-collapse-->
            </div>    
        </div>            
        <!-- End Navbar -->
    </div>
    <!--=== End Header ===--> 
<!--=== End Header ===-->


    <div class="breadcrumbs margin-bottom-10">
        <div class="container">
            <h2 class="pull-left">Design Patterns in the 21st Century: The Chain of Responsibility Pattern</h2>
            <ul class="pull-right breadcrumb">
                <li><a href="/">Home</a></li>
                
                    <li>
                    
                        <a href="/blog">Blog</a>
                    
                    </li>
                
            </ul>
        </div>
    </div>



<div class="container">
<div class="row blog-page blog-item">
<!-- Left Sidebar -->
<div class="col-md-9 md-margin-bottom-60">
    <!--Blog Post-->
    <div class="blog margin-bottom-40">
        
        <div class="blog-post-tags">
            <ul class="list-unstyled list-inline blog-info">
                <li><i class="fa fa-calendar"></i> 16 Apr 2015</li>
                <li><i class="fa fa-pencil"></i> Samir Talwar</li>
                <li class="blog-share-buttons">
                  <script src="//platform.linkedin.com/in.js" type="text/javascript"> lang: en_US</script>
                  <script type="IN/Share"></script>

                  <a class="twitter-share-button"
                      href="https://twitter.com/intent/tweet?url=http://www.codurance.com/2015/04/16/design-patterns-in-the-21st-century-part-four/"
                      data-count="none">
                      Tweet</a>
                </li>
            </ul>
        </div>
        

        
            <img class="img-responsive thumbnail blog-post-image" src="/assets/img/custom/blog/2015-04-13-design-patterns/part-four.jpg" alt="Design Patterns in the 21st Century: The Chain of Responsibility Pattern">
        

        <p>Here's a thing you might not see a lot.</p>

<pre><code>@Test public void hungryHungryPatrons() {
    KitchenStaff alice = new PieChef();
    KitchenStaff bob = new DollopDistributor();
    KitchenStaff carol = new CutleryAdder();
    KitchenStaff dan = new Server();

    alice.setNext(bob);
    bob.setNext(carol);
    carol.setNext(dan);

    Patron patron = new Patron();
    alice.prepare(new Pie()).forPatron(patron);

    assertThat(patron, hasPie());
}
</code></pre>

<p>It might look odd, but the idea is fairly common. For example, the Java Servlets framework uses the concept of a <code>FilterChain</code> to model a sequence of filters upon a request.</p>

<p>You can use <code>Filter</code> objects to do pretty much anything with a request. Here's one that tracks how many hits there have been to a site. Notice that it passes the <code>request</code> and <code>response</code> objects onto the next filter in the chain when it's done.</p>

<pre><code>public final class HitCounterFilter implements Filter {
    // initialization and destruction methods go here

    public void doFilter(
            ServletRequest request,
            ServletResponse response,
            FilterChain chain)
    {
        int hits = getCounter().incCounter();
        log(“The number of hits is ” + hits);
        chain.doFilter(request, response);
    }
}
</code></pre>

<p>We might use an object in the chain to modify the input or output (in this case, the request or response):</p>

<pre><code>public final class SwitchEncodingFilter implements Filter {
    // initialization and destruction methods go here

    public void doFilter(
            ServletRequest request,
            ServletResponse response,
            FilterChain chain)
    {
        request.setEncoding(“UTF-8”);
        chain.doFilter(request, response);
    }
}
</code></pre>

<p>We might even bail out of the chain early if things are going pear-shaped.</p>

<pre><code>public final class AuthorizationFilter implements Filter {
    // initialization and destruction methods go here

    public void doFilter(
            ServletRequest request,
            ServletResponse response,
            FilterChain chain)
    {
        if (!user().canAccess(request)) {
            throw new AuthException(user);
        }
        chain.doFilter(request, response);
    }
}
</code></pre>

<p>Basically, once you hit an element in the chain, it has full control.</p>

<p>In UML, it looks a little like this:</p>

<p><img src="/assets/img/custom/blog/2015-04-13-design-patterns/chain-of-responsibility-pattern-uml.png" alt="Chain of Responsibility pattern UML diagram" /></p>

<!-- more -->


<h4>This is probably bad practice.</h4>

<p>This may be a little contentious, but I'd say that most implementations of the Chain of Responsibility pattern are pretty confusing. Because the chain relies on each and every member playing its part correctly, it's very easy to simply lose things (in the case above, HTTP requests) by missing a line or two, reordering the chain without thinking through the ramifications, or mutating the <code>ServletRequest</code> in a fashion that makes later elements in the chain misbehave.</p>

<p>Let's dive a little further into how we can salvage something from all of this.</p>

<p>Remember our hungry patron?</p>

<pre><code>@Test public void
hungryHungryPatrons() {
    KitchenStaff alice = new PieChef();
    KitchenStaff bob = new DollopDistributor();
    KitchenStaff carol = new CutleryAdder();
    KitchenStaff dan = new Server();

    alice.setNext(bob);
    bob.setNext(carol);
    carol.setNext(dan);

    Patron patron = new Patron();
    alice.prepare(new Pie()).forPatron(patron);

    assertThat(patron, hasPie());
}
</code></pre>

<p>That assertion is using <a href="https://code.google.com/p/hamcrest/wiki/Tutorial#Sugar">Hamcrest matchers</a>, by the way. Check them out if you're not too familiar with them. They're amazing.</p>

<h4>Step 1: Stop mutating.</h4>

<p>Not all Chain of Responsibility implementations involve mutation, but for those that do, it's best to get rid of it as soon as possible. Making your code immutable makes it much easier to refactor further without making mistakes.</p>

<p>There are three cases of mutation here.</p>

<ol>
<li>Each member of staff has the "next" member set later, and the patrons themselves are mutated. Instead of setting the next member of staff later, we'll construct each one with the next.</li>
<li>Though you can't see it, Alice, the <code>PieChef</code>, sets a flag on the <code>Pie</code> to mark it as <code>cooked</code> for Bob, the <code>DollopDistributor</code>. Instead of changing the object, we'll have her accept an <code>UncookedPie</code> and pass a <code>CookedPie</code> to Bob. We then adapt Bob to accept a <code>CookedPie</code>. This ensures we can't get the order wrong, as <code>Bob</code> will never receive an uncooked pie.</li>
<li><p>And as for the patron, we'll start off with a <code>HungryPatron</code> and have them return a new instance of themselves upon feeding.</p>

<p> @Test public void
 hungryHungryPatrons() {
     KitchenStaff dan = new Server();
     KitchenStaff carol = new CutleryAdder(dan);
     KitchenStaff bob = new DollopDistributor(carol);
     KitchenStaff alice = new PieChef(bob);</p>

<pre><code> Patron hungryPatron = new HungryPatron();
 Patron happyPatron = alice.prepare(new UncookedPie()).forPatron(hungryPatron);

 assertThat(happyPatron, hasPie());
</code></pre>

<p> }</p></li>
</ol>


<p>This hasn't changed much, unfortunately. It's still very confusing why we giving the pie to Alice results in the patron receiving it, and we could still get things in the wrong order or ask the wrong person to do something.</p>

<h4>Step 2: Make it type-safe.</h4>

<p>Part of the problem with the ordering is that even though Alice gives the next person a <code>CookedPie</code>, we could tell her to give it to anyone, resulting in a <code>ClassCastException</code> or something equally fun. By parameterising the types, we can avoid this, ensuring that both the input and output types are correct.</p>

<pre><code>@Test public void
hungryHungryPatrons() {
    KitchenStaff&lt;WithCutlery&lt;Meal&gt;&gt; dan = new Server();
    KitchenStaff&lt;Meal&gt; carol = new CutleryAdder(dan);
    KitchenStaff&lt;CookedPie&gt; bob = new DollopDistributor(carol);
    KitchenStaff&lt;UncookedPie&gt; alice = new PieChef(bob);

    Patron hungryPatron = new HungryPatron();
    Patron happyPatron = alice.prepare(new UncookedPie()).forPatron(hungryPatron);

    assertThat(happyPatron, hasPie());
}
</code></pre>

<p>Each of our constructors will change too. For example, <code>PieChef</code>'s constructor used to look like this:</p>

<pre><code>public PieChef(KitchenStaff next) {
    this.next = next;
}
</code></pre>

<p>And now its parameter specifies the type it accepts:</p>

<pre><code>public PieChef(KitchenStaff&lt;CookedPie&gt; next) {
    this.next = next;
}
</code></pre>

<h4>Step 3: Separate behaviours.</h4>

<p><code>KitchenStaff</code> does two things: prepare food, but also hand over the food to the next person. Let's split that up into two different concepts. We'll construct an instance of <code>KitchenStaff</code>, then tell them who to delegate to next.</p>

<pre><code>@Test public void
hungryHungryPatrons() {
    KitchenStaff&lt;WithCutlery&lt;Meal&gt;, Serving&gt; dan = new Server();
    KitchenStaff&lt;Meal, Serving&gt; carol = new CutleryAdder().then(dan);
    KitchenStaff&lt;CookedPie, Serving&gt; bob = new DollopDistributor().then(carol);
    KitchenStaff&lt;UncookedPie, Serving&gt; alice = new PieChef().then(bob);

    Patron hungryPatron = new HungryPatron();
    Patron happyPatron = alice.prepare(new UncookedPie()).forPatron(hungryPatron);

    assertThat(happyPatron, hasPie());
}
</code></pre>

<p>In this situation, <code>then</code> doesn't modify the object directly, but instead returns a new instance of <code>KitchenStaff</code> who knows to pass it on. It looks something like this:</p>

<pre><code>private static interface KitchenStaff&lt;I, O&gt; {
    O prepare(I input);

    default &lt;Next&gt; KitchenStaff&lt;I, Next&gt; then(KitchenStaff&lt;O, Next&gt; next) {
        return input -&gt; {
            O output = prepare(input);
            return next.prepare(output);
        };
    }
}
</code></pre>

<p>To do this, we also have to return a value rather than operating purely on side effects, ensuring that we <em>always</em> pass on the value. In situations where we may not want to continue, we can return an <code>Optional&lt;T&gt;</code> value, which can contain either something (<code>Optional.of(value)</code>) or nothing (<code>Optional.empty()</code>).</p>

<h4>Step 4: Split the domain from the infrastructure.</h4>

<p>Now that we have separated the chaining from the construction of the <code>KitchenStaff</code>, we can separate the two. <code>alice</code>, <code>bob</code> and friends are useful objects to know about in their own right, and it's pretty confusing to see them only as part of the chain. Let's leave the chaining until later.</p>

<pre><code>@Test public void
hungryHungryPatrons() {
    KitchenStaff&lt;UncookedPie, CookedPie&gt; alice = new PieChef();
    KitchenStaff&lt;CookedPie, Meal&gt; bob = new DollopDistributor();
    KitchenStaff&lt;Meal, WithCutlery&lt;Meal&gt;&gt; carol = new CutleryAdder();
    KitchenStaff&lt;WithCutlery&lt;Meal&gt;, Serving&gt; dan = new Server();

    KitchenStaff&lt;UncookedPie, Serving&gt; staff = alice.then(bob).then(carol).then(dan);

    Patron hungryPatron = new HungryPatron();
    Patron happyPatron = staff.prepare(new UncookedPie()).forPatron(hungryPatron);

    assertThat(happyPatron, hasPie());
}
</code></pre>

<p>So now we have a composite object, <code>staff</code>, which embodies the chain of operations. This allows us to see the individuals as part of it as separate entities.</p>

<h4>Step 5: Identify redundant infrastructure.</h4>

<p>That <code>KitchenStaff</code> type looks awfully familiar at this point.</p>

<p>Perhaps it looks something like this:</p>

<pre><code>@FunctionalInterface
public interface Function&lt;T, R&gt; {
    R apply(T t);

    ...

    default &lt;V&gt; Function&lt;T, V&gt; andThen(Function&lt;? super R, ? extends V&gt; after) {
        Objects.requireNonNull(after);
        return (T t) -&gt; after.apply(apply(t));
    }

    ...
}
</code></pre>

<p>Oh, look, it's a function! And <code>then</code> is simply function composition. Our <code>KitchenStaff</code> type appears to be pretty much a subset of the <code>Function</code> type, so why not just use that instead?</p>

<pre><code>@Test public void
hungryHungryPatrons() {
    Function&lt;UncookedPie, CookedPie&gt; alice = new PieChef();
    Function&lt;CookedPie, Meal&gt; bob = new DollopDistributor();
    Function&lt;Meal, WithCutlery&lt;Meal&gt;&gt; carol = new CutleryAdder();
    Function&lt;WithCutlery&lt;Meal&gt;, Serving&gt; dan = new Server();

    Function&lt;UncookedPie, Serving&gt; staff = alice.andThen(bob).andThen(carol).andThen(dan);

    Patron hungryPatron = new HungryPatron();
    Patron happyPatron = staff.apply(new UncookedPie()).forPatron(hungryPatron);

    assertThat(happyPatron, hasPie());
}
</code></pre>

<h4>Step 6: Optionally replace classes with lambdas and method references.</h4>

<p>Sometimes you really don't need a full class. In this case, the implementation is simple enough that we can just use method references instead.</p>

<pre><code>@Test public void
hungryHungryPatrons() {
    Function&lt;UncookedPie, CookedPie&gt; alice = UncookedPie::cook;
    Function&lt;CookedPie, Meal&gt; bob = CookedPie::addCream;
    Function&lt;Meal, WithCutlery&lt;Meal&gt;&gt; carol = WithCutlery::new;
    Function&lt;WithCutlery&lt;Meal&gt;, Serving&gt; dan = Serving::new;

    Function&lt;UncookedPie, Serving&gt; staff = alice.andThen(bob).andThen(carol).andThen(dan);

    Patron hungryPatron = new HungryPatron();
    Patron happyPatron = staff.apply(new UncookedPie()).forPatron(hungryPatron);

    assertThat(happyPatron, hasPie());
}
</code></pre>

<p>This drastically cuts down on boilerplate and lets us see what's actually going on.</p>

<p>Our new structure is quite different—far more so than the earlier examples.</p>

<p><img src="/assets/img/custom/blog/2015-04-13-design-patterns/chain-of-responsibility-pattern-uml-functional.png" alt="Updated Chain of Responsibility pattern UML diagram" /></p>

<p>By decoupling the business domain (in this case, pie preparation) from the infrastructure (composed functions), we're able to come up with much cleaner, terser code. Our behavioural classes (focusing around preparation) disappeared, leaving only the domain objects themselves (<code>UncookedPie</code>, for example) and the methods on them (e.g. <code>cook</code>), which is where the behaviour should probably live anyway.</p>


        
        <hr/>
        <p class="cross-post"><a href="http://monospacedmonologues.com/post/116569171260/design-patterns-in-the-21st-century-the-chain-of">This post was cross-posted to my personal blog.</a></p>
        
    </div>
    <!--End Blog Post-->
</div>
<!-- End Left Sidebar -->

<!-- Right Sidebar -->
<div class="col-md-3 magazine-page">
    <!-- Blog Latest Tweets -->
    <div class="blog-twitter margin-bottom-30">
        <a class="twitter-timeline" href="https://twitter.com/mashooq/codurance" data-widget-id="400789734676385792">Tweets from Codurance team</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
<script>window.twttr = (function(d, s, id) {var js, fjs = d.getElementsByTagName(s)[0],t = window.twttr || {};if (d.getElementById(id)) return t;js = d.createElement(s);js.id = id;js.src = "https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, "script", "twitter-wjs"));</script>
    </div>
    <!-- End Blog Latest Tweets -->
</div>
<!-- End Right Sidebar -->
</div>
<!--/row-->
</div>
<!--/container-->


<!--=== Copyright ===-->
<div class="footer-default">
    <div class="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <p class="copyright-space">
                        2013 &copy; Codurance LTD.
                         | Company Registration No: 8712584
                         | Contact us: <a href="mailto:hello@codurance.com" class="">hello@codurance.com</a>
                         | Phone: +44 203 440 4015
                    </p>

                </div>
                <div class="col-md-4">
                    <ul class="social-icons pull-right">
                        <li><a href="/atom.xml" data-original-title="Feed" class="social_rss"></a></li>
                        <li><a href="http://twitter.com/codurance" data-original-title="Twitter" class="social_twitter"></a></li>
                    </ul>
                </div>
            </div> <!--/row-->
        </div> <!--/container-->
    </div><!--/copyright-->
</div>

<!--=== End Copyright ===-->
</div>

<!-- JS Global Compulsory -->
<script type="text/javascript" src="/assets/plugins/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/assets/plugins/jquery/jquery-migrate.min.js"></script>
<script type="text/javascript" src="/assets/plugins/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/assets/plugins/back-to-top.js"></script>
<!-- JS Implementing Plugins -->
<script type="text/javascript" src="/assets/plugins/owl-carousel/owl-carousel/owl.carousel.js"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript" src="/assets/plugins/gmap/gmap.js"></script>
<!-- JS Customization -->
<script type="text/javascript" src="/assets/js/custom.js"></script>
<!-- JS Page Level -->
<script type="text/javascript" src="/assets/js/app.js"></script>
<script type="text/javascript" src="/assets/js/pages/index.js"></script>

<script type="text/javascript">
    jQuery(document).ready(function() {
        App.init();
        Index.initOwlCarousel();
        Contact.initMap();
    });
</script>
<!--[if lt IE 9]>
    <script src="/assets/plugins/respond.js"></script>
    <script src="/assets/plugins/html5shiv.js"></script> 
    <script src="/assets/js/plugins/placeholder-IE-fixes.js"></script>   
<![endif]-->

</body>
</html>
