<!DOCTYPE html>
<!--[if IE 8]> <html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9]> <html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!--> <html lang="en"> <!--<![endif]-->
<head>
<title>Codurance - Side effects and Java 8 streams</title>
 <!-- Meta -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">

<!-- Open Graph tags - Used when publishing on Facebook -->
<meta property="og:site_name" content="Codurance"/>
<meta property="og:description" content="We build well-crafted software"/>
<meta property="og:url" content="http://codurance.com"/>
<meta property="og:image" content="http://codurance.com/assets/img/codurance.png"/>

<!-- Favicon -->
<link rel="shortcut icon" href="favicon.ico">

<!-- CSS Global Compulsory -->
<link rel="stylesheet" href="/assets/plugins/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/assets/css/style.css">

<!-- CSS Implementing Plugins -->
<link rel="stylesheet" href="/assets/plugins/line-icons/line-icons.css">
<link rel="stylesheet" href="/assets/plugins/font-awesome/css/font-awesome.min.css">
<link rel="stylesheet" href="/assets/plugins/owl-carousel/owl-carousel/owl.carousel.css">

<!-- CSS Theme -->  
<link rel="stylesheet" href="/assets/css/plugins.css">
<link rel="stylesheet" href="/assets/css/app.css">  
<link rel="stylesheet" href="/assets/css/theme-colors/orange.css" id="style_color">

<!-- CSS Customization -->
<link rel="stylesheet" href="/assets/css/custom.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/idea.min.css">
<!--fonts -->
<link href='http://fonts.googleapis.com/css?family=Oxygen:700,400' rel='stylesheet' type='text/css'>



<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46289079-1', 'codurance.com');
    ga('send', 'pageview');
</script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</head>

<body>

<div class="wrapper">
<!--=== Header ===-->
<div class="header-v3 header-sticky">
        <!-- Navbar -->
        <div class="navbar navbar-default" role="navigation">
            <div class="container">
                <!-- Brand and toggle get grouped for better mobile display -->
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="fa fa-bars"></span>
                    </button>
                    <a class="navbar-brand" href="/">
                        <img id="logo-header" src="/assets/img/codurance.png" height="45px;" alt="Logo">
                    </a>
                </div>

                <!-- Collect the nav links, forms, and other content for toggling -->
                <div class="collapse navbar-collapse navbar-responsive-collapse">
                    <ul class="nav navbar-nav">
                        <li><a href="/services">Services</a></li>
                        <li><a href="/casestudies">Case Studies</a></li>
                        <li><a href="/videos">Videos</a></li>
                        <li><a href="/blog">Blog</a></li>
                        <li><a href="/careers/craftsman">Careers</a></li>
                        <li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown">About Us <i class="icon-angle-down">&nbsp;</i></a><ul class="dropdown-menu">
                            <li><a href="/aboutus/ourteam">Our Team</a></li>
                            <li><a href="/aboutus/ourcompany">Our Company</a></li>
                            <li><a href="/aboutus/ourpractices">Our Practices</a></li>
                        </ul></li>
                    </ul>
                </div><!--/navbar-collapse-->
            </div>    
        </div>            
        <!-- End Navbar -->
    </div>
    <!--=== End Header ===--> 
<!--=== End Header ===-->


    <div class="breadcrumbs margin-bottom-10">
        <div class="container">
            <h2 class="pull-left">Side effects and Java 8 streams</h2>
            <ul class="pull-right breadcrumb">
                <li><a href="/">Home</a></li>
                
                    <li>
                    
                        <a href="/blog">Blog</a>
                    
                    </li>
                
            </ul>
        </div>
    </div>



<div class="container">
<div class="row blog-page blog-item">
<!-- Left Sidebar -->
<div class="col-md-9 md-margin-bottom-60">
    <!--Blog Post-->
    <div class="blog margin-bottom-40">
        
        <div class="blog-post-tags">
            <ul class="list-unstyled list-inline blog-info">
                <li><i class="fa fa-calendar"></i> 04 May 2015</li>
                <li><i class="fa fa-pencil"></i> Felipe Fernandez</li>
                <li class="blog-twitter-button">
                  <a class="twitter-share-button"
                      href="https://twitter.com/intent/tweet?url=http://www.codurance.com/2015/05/04/side-effects-and-java-8-streams/"
                      data-counturl="http://www.codurance.com/2015/05/04/side-effects-and-java-8-streams/">
                      Tweet</a>
                </li>
            </ul>
        </div>
        

        
            <img class="img-responsive thumbnail blog-post-image" src="/assets/img/custom/blog/2015-05-04-side-effects-and-java-8-streams/stream.jpg" alt="Side effects and Java 8 streams">
        

        <p>There is a lot of excitement in the Java community since Java 8 was released. Lambdas and Streams are a massive improvement and nobody wants to go back to the old days. Today, however, I want to talk about the caveats of some use of Java Streams.</p>

<p>When you start using Streams and its functional capabilities you start seeing your code as some pipeline of computational operations. As you're abstracting low-level concerns as iteration details, you can focus on the rules (business, english-like rules) of your transformations. Then your mindset gets even more abstract (as it usually happens when you have exposure to functional programming) and you realise that almost every piece of application server code that you've written can be abstracted as a pipeline of transformations in some data that sends messages during the process (aka, side effects).</p>

<p>Even if we use DDD or any OOP design practice, that key principle stands. Then the temptation to model our whole flow (from Rest adapter to DB or Event Stores) as a single Stream is quite strong. Let's provide an example.</p>

<p>Let's say that we have a football league application and we want to check that the day before a match everything is ready to play. Let's see the data in different steps of the pipeline:</p>

<ol>
<li><p>Subscribed players</p>

<ol type="a">
<li>(filter) Check if they're available for the match</li>
</ol>
</li>
<li><p>Available players</p>

<ol type="a">
<li>(map) Create a team</li>
</ol>
</li>
<li><p>Team ....</p></li>
</ol>


<p>In 1.a we want to send a reminder email to the guys that have marked themselves previously as available and in 2.a we want to store that team in some DB. Those behaviours could and should live in different components, but conceptually that flow is the same stream. We want to use the data to execute the side effects but not consume it, as we want to keep using the stream.</p>

<h2>Understanding execution order with the <code>peek</code> method.</h2>

<p><code>peek</code> is a method in the Java 8 Stream API that allows you to use but not consume the data of an stream. We might think that it's a good idea to use <code>peek</code> to send messages to EmailAdapter and TeamRepository. The problem with <code>peek</code> is that it's only executed whenever we do actually consume the stream. The Javadoc provides some clues about that:</p>

<blockquote><p>This method exists mainly to support debugging additionally performing the provided action on each element as elements are consumed from the resulting stream.</p></blockquote>

<p><em>As elements are consumed</em> is the key, but it's not obvious the first time you read it. In the provided snippet we can see how <code>peek</code> is executed only when a final operation (<code>forEach</code> in this case) is called:</p>

<pre><code class="java">public static void main(String[] args) {
    IntStream stream = createAStreamAndPerformSomeSideEffectWithPeek();
    System.out.println("Second. I should be the second group of prints");
    consumeTheStream(stream);
}

private static IntStream createAStreamAndPerformSomeSideEffectWithPeek() {
    return IntStream.of(1, 2, 3)
            .peek(number -&gt; System.out.println(String.format("First. My number is %d", number)))
            .map(number -&gt; number + 1);
}

private static void consumeTheStream(IntStream stream) {
    stream.filter(number -&gt; number % 2 == 0)
            .forEach(number -&gt; System.out.println(String.format("Third. My number is %d", number)));
}
</code></pre>

<p>We might expect an output like this:</p>

<ul>
<li>First. My number is 1</li>
<li>First. My number is 2</li>
<li>First. My number is 3</li>
<li>Second. I should be the second group of prints</li>
<li>Third. My number is 2</li>
<li>Third. My number is 4</li>
</ul>


<p>When in fact we'll have:</p>

<ul>
<li>Second. I should be the second group of prints</li>
<li>First. My number is 1</li>
<li>Third. My number is 2</li>
<li>First. My number is 2</li>
<li>First. My number is 3</li>
<li>Third. My number is 4</li>
</ul>


<p>A clever reader could state that the problem was the inclusion of some non-stream operation in the middle of a lazy pipeline. That could be true. For instance when you work in asynchronous code like promises in Node.js is quite important not to mix sequential code with the async chain without a lot of a thought.</p>

<h2>Understanding laziness through Optional API.</h2>

<p>Non-immediate execution using threads, RxJava, streams or any "lazy" construct could be confusing for a Java developer used to sequential flows. This is a really silly example using Java 8 Optional API that confused me the first time that I saw it:</p>

<pre><code class="java">return fetchTrackBy(device).orElse(trackRepository.saveTrackWith(metadata));
</code></pre>

<p><code>fetchTrackBy</code> returns an Optional so that code could be thought as syntactic sugar. It would unroll to this:</p>

<pre><code class="java">Track track = fetchTrackBy(device);
if (track.isPresent()) {
    return track.get();
}
return trackRepository.saveTrackWith(metadata);
</code></pre>

<p>In fact, there is a bug in the first implementation. Did you spot it? Yes, we're saving the track even if we found it in first place. We'd fix it with this implementation:</p>

<pre><code class="java">return fetchTrackBy(device).orElseGet(() -&gt; trackRepository.saveTrackWith(metadata));
</code></pre>

<p>As you can see we're providing a lambda (an implementation of the <code>Supplier</code> functional interface) that will be evaluated lazily if the Optional is not present.</p>

<h2>Other thoughts about Streams</h2>

<p>Coming back to Streams, reading the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/package-summary.html">Javadoc</a> seems to be quite useful for our concerns. About side effects:</p>

<blockquote><p>Side-effects in behavioral parameters to stream operations are, in general, discouraged, as they can often lead to unwitting violations of the statelessness requirement, as well as other thread-safety hazards.</p></blockquote>

<p>We can see an example of a stateful lambda here:</p>

<pre><code class="java">Set&lt;Integer&gt; seen = Collections.synchronizedSet(new HashSet&lt;&gt;());
stream.parallel().map(e -&gt; { if (seen.add(e)) return 0; else return e; })
</code></pre>

<blockquote><p>If the behavioral parameters do have side-effects, unless explicitly stated, there are no guarantees as to the visibility of those side-effects to other threads, nor are there any guarantees that different operations on the "same" element within the same stream pipeline are executed in the same thread</p></blockquote>

<p>This is really important to note, but we could say that for our example is not relevant as we want to send messages to external processes with their own concurrency mechanisms. Something more like:</p>

<blockquote><p>However, side-effects such as using println() for debugging purposes are usually harmless.</p></blockquote>

<p>There are another problems about using Stream as backbone of our flows. Once a Stream is consumed it's not possible to reuse it again. That means that storing a Stream as a field of some of our domain objects feels like a dangerous idea, as that domain object will be useless once that field is consumed. An idea to mitigate that problem is wrapping that Stream in a Supplier, generating a new stream every time that we request access to that field. This is similar to an <code>Iterable</code>, which creates a new <code>Iterator</code> each time the <code>iterator()</code> method is called.</p>

<h2>In conclusion</h2>

<p>I would discourage passing around streams in teams with little experience with Java 8. If we decide to apply side effects during the pipeline, I would avoid any side effect that implies some kind of locking or coordination between threads. That said, I would recommend experimenting with these ideas in your spare time, as I found that the best way of learning is by applying <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/package-summary.html#package.description">the core ideas of Java 8 Streams</a>:</p>

<blockquote><ul>
<li>No storage. A stream is not a data structure that stores elements; instead, it conveys elements from a source such as a data structure, an array, a generator function, or an I/O channel, through a pipeline of computational operations.</li>
<li>Functional in nature. An operation on a stream produces a result, but does not modify its source. For example, filtering a Stream obtained from a collection produces a new Stream without the filtered elements, rather than removing elements from the source collection.</li>
<li>Laziness-seeking. Many stream operations, such as filtering, mapping, or duplicate removal, can be implemented lazily, exposing opportunities for optimization. For example, "find the first String with three consecutive vowels" need not examine all the input strings. Stream operations are divided into intermediate (Stream-producing) operations and terminal (value- or side-effect-producing) operations. Intermediate operations are always lazy.</li>
<li>Possibly unbounded. While collections have a finite size, streams need not. Short-circuiting operations such as limit(n) or findFirst() can allow computations on infinite streams to complete in finite time.</li>
<li>Consumable. The elements of a stream are only visited once during the life of a stream. Like an Iterator, a new stream must be generated to revisit the same elements of the source.</li>
</ul>
</blockquote>


        
    </div>
    <!--End Blog Post-->
</div>
<!-- End Left Sidebar -->

<!-- Right Sidebar -->
<div class="col-md-3 magazine-page">
    <!-- Blog Latest Tweets -->
    <div class="blog-twitter margin-bottom-30">
        <a class="twitter-timeline" href="https://twitter.com/mashooq/codurance" data-widget-id="400789734676385792">Tweets from Codurance team</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
<script>window.twttr = (function(d, s, id) {var js, fjs = d.getElementsByTagName(s)[0],t = window.twttr || {};if (d.getElementById(id)) return t;js = d.createElement(s);js.id = id;js.src = "https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, "script", "twitter-wjs"));</script>
    </div>
    <!-- End Blog Latest Tweets -->
</div>
<!-- End Right Sidebar -->
</div>
<!--/row-->
</div>
<!--/container-->


<!--=== Copyright ===-->
<div class="footer-default">
    <div class="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <p class="copyright-space">
                        2013 &copy; Codurance LTD.
                         | Company Registration No: 8712584
                         | Contact us: <a href="mailto:hello@codurance.com" class="">hello@codurance.com</a>
                         | Phone: +44 203 440 4015
                    </p>

                </div>
                <div class="col-md-4">
                    <ul class="social-icons pull-right">
                        <li><a href="/atom.xml" data-original-title="Feed" class="social_rss"></a></li>
                        <li><a href="http://twitter.com/codurance" data-original-title="Twitter" class="social_twitter"></a></li>
                    </ul>
                </div>
            </div> <!--/row-->
        </div> <!--/container-->
    </div><!--/copyright-->
</div>

<!--=== End Copyright ===-->
</div>

<!-- JS Global Compulsory -->
<script type="text/javascript" src="/assets/plugins/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/assets/plugins/jquery/jquery-migrate.min.js"></script>
<script type="text/javascript" src="/assets/plugins/bootstrap/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/assets/plugins/back-to-top.js"></script>
<!-- JS Implementing Plugins -->
<script type="text/javascript" src="/assets/plugins/owl-carousel/owl-carousel/owl.carousel.js"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript" src="/assets/plugins/gmap/gmap.js"></script>
<!-- JS Customization -->
<script type="text/javascript" src="/assets/js/custom.js"></script>
<!-- JS Page Level -->
<script type="text/javascript" src="/assets/js/app.js"></script>
<script type="text/javascript" src="/assets/js/pages/index.js"></script>

<script type="text/javascript">
    jQuery(document).ready(function() {
        App.init();
        Index.initOwlCarousel();
        Contact.initMap();
    });
</script>
<!--[if lt IE 9]>
    <script src="/assets/plugins/respond.js"></script>
    <script src="/assets/plugins/html5shiv.js"></script> 
    <script src="/assets/js/plugins/placeholder-IE-fixes.js"></script>   
<![endif]-->

</body>
</html>
